<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Big Complex Labyrinth - A-Frame</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script>
      function getBoundingBox(el) {
        const pos = el.object3D.position;
        const geo = el.getAttribute('geometry');
        if (!geo) return null;
        let width = geo.width || geo.radius || 1;
        let height = geo.height || geo.radius || 1;
        let depth = geo.depth || geo.radius || 1;
        if (geo.primitive === 'tetrahedron') {
          width = height = depth = geo.radius || 1;
        }
        return {
          min: { x: pos.x - width/2, y: pos.y - height/2, z: pos.z - depth/2 },
          max: { x: pos.x + width/2, y: pos.y + height/2, z: pos.z + depth/2 }
        };
      }

      AFRAME.registerComponent('advanced-collision', {
        schema: { obstacles: {type: 'selectorAll'} },
        init: function () {
          this.lastValidPosition = this.el.object3D.position.clone();
        },
        tick: function () {
          const camera = this.el.object3D;
          const current = camera.position;
          const radius = 0.5;
          for (let obstacle of this.data.obstacles) {
            const box = getBoundingBox(obstacle);
            if (!box) continue;
            if (
              current.x + radius > box.min.x &&
              current.x - radius < box.max.x &&
              current.y + radius > box.min.y &&
              current.y - radius < box.max.y &&
              current.z + radius > box.min.z &&
              current.z - radius < box.max.z
            ) {
              camera.position.copy(this.lastValidPosition);
              return;
            }
          }
          this.lastValidPosition.copy(current);
        }
      });

      AFRAME.registerComponent('random-objects', {
        schema: { cubeCount: {type: 'int', default: 15}, pyramidCount: {type: 'int', default: 15} },
        init: function () {
          this.generateObjects();
        },
        generateObjects: function () {
          if (window.generatedObjects) {
            window.generatedObjects.forEach(obj => {
              if (obj.parentNode) obj.parentNode.removeChild(obj);
            });
          }
          window.generatedObjects = [];
          this.objectsLeft = this.data.cubeCount + this.data.pyramidCount;
          // Bigger range for objects
          const minX = -9, maxX = 9, minZ = -9, maxZ = 9, minY = 0.6, maxY = 1.2;
          const minScale = 0.2, maxScale = 0.5;
          for (let i = 0; i < this.data.cubeCount; i++) {
            let sx = minScale + Math.random() * (maxScale - minScale);
            let sy = minScale + Math.random() * (maxScale - minScale);
            let sz = minScale + Math.random() * (maxScale - minScale);
            let px = minX + Math.random() * (maxX - minX);
            let py = minY + Math.random() * (maxY - minY);
            let pz = minZ + Math.random() * (maxZ - minZ);
            let el = document.createElement('a-box');
            el.setAttribute('position', {x: px, y: py, z: pz});
            el.setAttribute('width', sx);
            el.setAttribute('height', sy);
            el.setAttribute('depth', sz);
            el.setAttribute('color', `#${Math.floor(Math.random()*16777215).toString(16)}`);
            el.setAttribute('class', 'clickable');
            el.addEventListener('click', () => { this.handleObjectClick(el); });
            this.el.appendChild(el);
            window.generatedObjects.push(el);
          }
          for (let i = 0; i < this.data.pyramidCount; i++) {
            let scale = minScale + Math.random() * (maxScale - minScale);
            let px = minX + Math.random() * (maxX - minX);
            let py = minY + Math.random() * (maxY - minY);
            let pz = minZ + Math.random() * (maxZ - minZ);
            let el = document.createElement('a-entity');
            el.setAttribute('geometry', {primitive: 'tetrahedron', radius: scale});
            el.setAttribute('position', {x: px, y: py, z: pz});
            el.setAttribute('material', `color: #${Math.floor(Math.random()*16777215).toString(16)}`);
            el.setAttribute('class', 'clickable');
            el.addEventListener('click', () => { this.handleObjectClick(el); });
            this.el.appendChild(el);
            window.generatedObjects.push(el);
          }
        },
        handleObjectClick: function (el) {
          if (el.parentNode) el.parentNode.removeChild(el);
          this.objectsLeft--;
          if (this.objectsLeft === 0) {
            setTimeout(() => {
              this.generateObjects();
              let cam = document.querySelector('[camera]');
              let ids = [
                '#wall1_left','#wall1_right','#wall2','#wall3','#wall4',
                '#intwall1','#intwall2','#intwall3','#intwall4','#intwall5','#intwall6','#door'
              ];
              let staticObstacles = ids.map(id => document.querySelector(id));
              let dynamicObstacles = window.generatedObjects || [];
              cam.setAttribute('advanced-collision', {obstacles: staticObstacles.concat(dynamicObstacles)});
            }, 800);
          }
        }
      });
    </script>
  </head>
  <body>
    <a-scene random-objects>
      <a-sky color="#222"></a-sky>
      <!-- External walls for a 20x20 room, opening at the front -->
      <a-box id="wall1_left" position="-6 1 -10" width="8" height="2" depth="0.3" color="#555"></a-box>
      <a-box id="wall1_right" position="6 1 -10" width="8" height="2" depth="0.3" color="#555"></a-box>
      <a-box id="wall2" position="10 1 0" width="0.3" height="2" depth="20" color="#555"></a-box>
      <a-box id="wall3" position="0 1 10" width="20" height="2" depth="0.3" color="#555"></a-box>
      <a-box id="wall4" position="-10 1 0" width="0.3" height="2" depth="20" color="#555"></a-box>
      <!-- Internal walls for more complexity -->
      <a-box id="intwall1" position="-5 1 -5" width="10" height="2" depth="0.3" color="#666"></a-box>
      <a-box id="intwall2" position="5 1 -5" width="10" height="2" depth="0.3" color="#666"></a-box>
      <a-box id="intwall3" position="0 1 0" width="0.3" height="2" depth="10" color="#666"></a-box>
      <a-box id="intwall4" position="-5 1 5" width="10" height="2" depth="0.3" color="#666"></a-box>
      <a-box id="intwall5" position="5 1 5" width="10" height="2" depth="0.3" color="#666"></a-box>
      <a-box id="intwall6" position="5 1 0" width="0.3" height="2" depth="10" color="#666"></a-box>
      <!-- A central "door" -->
      <a-box id="door" position="0 1 -8" width="4" height="2" depth="0.3" color="#ff0"></a-box>
      <!-- Camera with advanced collision and cursor for mouse click -->
      <a-entity 
        camera 
        wasd-controls="acceleration: 20" 
        look-controls 
        position="0 1.6 -13"
        advanced-collision="obstacles: #wall1_left, #wall1_right, #wall2, #wall3, #wall4, #intwall1, #intwall2, #intwall3, #intwall4, #intwall5, #intwall6, #door"
      >
        <!-- Cursor for mouse interaction -->
        <a-entity 
          cursor="fuse: false; rayOrigin: mouse"
          raycaster="objects: .clickable"
          position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
          material="color: #FFF; shader: flat">
        </a-entity>
      </a-entity>
      <!-- Update collisions after objects are generated -->
      <script>
        document.addEventListener("DOMContentLoaded", function(){
          setTimeout(function(){
            let cam = document.querySelector('[camera]');
            let ids = [
              '#wall1_left','#wall1_right','#wall2','#wall3','#wall4',
              '#intwall1','#intwall2','#intwall3','#intwall4','#intwall5','#intwall6','#door'
            ];
            let staticObstacles = ids.map(id => document.querySelector(id));
            let dynamicObstacles = window.generatedObjects || [];
            cam.setAttribute('advanced-collision', {obstacles: staticObstacles.concat(dynamicObstacles)});
          }, 1000);
        });
      </script>
    </a-scene>
  </body>
</html>
